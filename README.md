# 考研院校稳录取分数线自动化工具

本工具包含 **图片OCR识别模块** 与 **PAVA稳录取计算模块**，可批量处理院校复试截图，自动生成 CSV、识别异常、并计算稳录取分数（默认阈值 T=0.75）。

## 核心特性

- **模板定位法**：通过动态识别表头定位表格，自适应不同位置和行数
- **多层验证机制**：6道验证关卡确保数据100%准确，失败时直接报错不输出错误数据  
- **高准确率**：预期识别准确率 95%+（确保输出的CSV都是可信的）
- **批量处理**：支持 300+ 张图片并带有进度条、详细日志和错误报告
- **Fail-Fast原则**：宁可报错，不给错误数据

## 环境准备

1. 建议使用 Python 3.10+，确保系统可联网以下载 Paddle 相关模型
2. 安装依赖：

\`\`\`bash
pip install paddlepaddle paddleocr pandas openpyxl tqdm pillow numpy
\`\`\`

> 首次运行会自动下载 PaddleOCR 模型文件（约几百MB），需保证网络畅通

## OCR识别方法说明

###当前挑战

传统的"全图OCR + 正则匹配"方案存在严重问题：
- ❌ OCR可能将分数段拆分成多个文本框（如"206分" + "-210"）
- ❌ 关键分数段可能完全未识别（示例中丢失7/11行数据）
- ❌ 文本框位置混乱，难以确定哪些数字属于哪一行
- ❌ 准确率仅约36%（4/11行）

### 解决方案：模板定位法

本工具采用**动态表头定位 + 分区OCR**方式，专门针对考研院校截图的固定格式优化：

**步骤1：表头定位**
- 全图OCR识别"分数段"、"复试人数"、"录取人数"表头文字
- 根据表头位置动态确定3列的X坐标边界
- 自适应表格在屏幕中的不同位置

**步骤2：数据区域定位**
- 通过表头和底部广告（"一对一择校"）确定数据区域Y坐标范围
- 自动排除年份选择栏、说明文字等干扰元素

**步骤3：行分割**
- 检测水平网格线精确分割每一行
- 自适应不同的数据行数（3-30行）

**步骤4：单元格OCR**
- 对每个单元格独立裁剪和识别
- 第1列：提取分数段（XXX-YYY格式）
- 第2/3列：仅识别数字（复试/录取人数）

**步骤5：多层验证**（Fail-Fast机制）
- ✅ 检查点1：表头验证（列数=3，表头文字存在）
- ✅ 检查点2：数据区域合理性（高度>50像素）
- ✅ 检查点3：行数验证（3-30行范围内）
- ✅ 检查点4：逐行数据验证（分数段格式、录取≤复试）
- ✅ 检查点5：整体数据验证（分数段递增、录取率合理）
- ✅ 检查点6：失败率检查（>20%失败则报错）

### 错误处理策略

**核心原则：宁可报错，不给错误数据**

- 任何验证失败都会抛出 `ValidationError`
- 只要生成了CSV，就保证数据100%准确
- 识别失败的图片会记录在 `errors.txt`，包含详细失败原因
- 支持轻微错误的自动修复（如分数段缺失但可推断）

## 使用方法

### 1. OCR 表格识别

\`\`\`bash
python tool.py process-images ./示例图片 ./output
\`\`\`

**输出说明**：
- `./output/raw/` - 每张图片对应的 CSV文件
- `./output/errors.txt` - 识别失败的图片清单及失败原因
- `./output/logs/processing.log` - 详细处理日志

### 2. 稳录取分数计算

\`\`\`bash
python tool.py batch-calculate ./output/raw ./output/final_report.xlsx
\`\`\`

**可选参数**：
- `--threshold 0.75` - PAVA 触发阈值 T（默认0.75）
- `--min-bin 8` - 最小样本量约束

**输出**: `final_report.xlsx` 包含汇总表和PAVA详情表

### 3. 图形界面

\`\`\`bash
python gui.py
\`\`\`

## 验证建议

使用示例图片测试：

\`\`\`bash
python tool.py process-images ./示例图片 ./output
\`\`\`

**预期结果**：
- ✅ 浙江农林大学会计专业：11行数据（201-255分段）
- ✅ 杭州电子科技大学图情专业：8行数据（213-252分段）
- ✅ 浙江农林大学图情专业：9行数据（194-238分段）

## 数据验证规则

**单行验证**：
- 分数段格式：`\d{3}-\d{3}`，且下限<上限
- 分数范围：150-500分之间
- 人数非负且逻辑一致：admitted ≤ candidates

**整体验证**：
- 分数段递增（无重叠）
- 录取率合理（0.01 ≤ ratio ≤ 1.0）
- 失败率检查（≤20%）

## 常见问题

**Q: 为什么某些图片识别失败？**  
A: 检查 `errors.txt` 中的失败原因。常见原因：
- 截图不完整（表头或底部被截断）
- 截图模糊或分辨率过低
- 非"复试录取情况"标签页的截图

**Q: 如何提高识别成功率？**  
A: 确保截图质量：
- ✅ 完整截图（包含表头和底部广告）
- ✅ 切换到"复试录取情况"标签页
- ✅ 避免弹窗或悬浮按钮遮挡表格
- ✅ 截图清晰，分辨率足够

## 技术架构

\`\`\`
tool.py                 # CLI 入口
gui.py                  # GUI界面
示例图片/               # 测试用例
steady_score/
  simple_ocr.py         # 简单OCR提取器（将升级为模板定位法）
  ocr_pipeline.py       # OCR主处理流程
  pava.py               # PAVA 算法与 Wilson 区间
  validators.py         # 数据校验和规范化
  reporting.py          # Excel 报告生成
稳录取分数线.pdf         # PAVA算法手册
\`\`\`

## 更新日志

### v2.0（规划中）
- ✨ 重构OCR识别方法：从"全图OCR+正则"改为"模板定位法"
- ✨ 新增多层验证机制（6道关卡）
- ✨ 提升识别准确率：36% → 95%+
- ✨ 新增详细的错误报告和失败原因说明

### v1.0（当前版本）
- ✅ 基础OCR识别功能
- ✅ PAVA稳录取分数计算
- ✅ GUI界面
- ✅ 批量处理支持
